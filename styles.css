:root {
  --bg: #fafafa;
  --text: #2a2a2a;
  --text-muted: #6a6a6a;
  --accent: #5a5a5a;
  --accent-secondary: rgba(90, 203, 251, 0.2);
  --void: #0a0a0a;
  --font-mono: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
  --font-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  --duration-slow: 2s;
  --duration-med: 1s;
  --duration-fast: 0.4s;
}

*,
*::before,
*::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html,
body {
  block-size: 100%;
  overflow: hidden;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-system);
  perspective: 1000px;
  transition: background-color var(--duration-slow);
}

main {
  position: relative;
  block-size: 100dvh;
  inline-size: 100%;
  transition: transform var(--duration-slow);
}

/* Vortex Background */
.vortex-container {
  block-size: 100%;
  display: grid;
  place-items: center;

  .node {
    inline-size: 92%;
    block-size: 92%;
    border: 2px solid var(--accent-secondary);
    border-radius: 40%;
    display: grid;
    place-items: center;
    transform: rotate(8deg) scale(0.95);
    filter: hue-rotate(8deg);
    animation: pulse 8s ease-in-out infinite alternate;
  }
}

/* Character */
.character {
  position: fixed;
  inset-inline-start: 50%;
  inset-block-start: 50%;
  translate: -50% -50%;
  transition: all var(--duration-slow) cubic-bezier(0.4, 0.0, 0.2, 1);
  pointer-events: none;

  .face {
    font-family: var(--font-mono);
    font-size: clamp(2.5rem, 7dvw, 6rem);
    font-weight: 700;
    letter-spacing: -0.1em;
    user-select: none;
    display: block;
    transition: all var(--duration-fast);
    white-space: nowrap;
    position: relative;

    &::before {
      position: absolute;
      inset: 0;
      letter-spacing: normal;
    }
  }
}

/* Scene Container */
.scene {
  position: absolute;
  inset: 0;
  display: grid;
  place-items: start;
  padding-inline-start: clamp(2rem, 10dvw, 8rem);
  padding-block-start: clamp(2rem, 10dvh, 8rem);
  padding-block-end: 3rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--duration-med);
  overflow-y: auto;
  overflow-x: hidden;
  content-visibility: hidden;

  .content {
    max-inline-size: 60ch;
    inline-size: 100%;
  }
}

/* Base Typography */
h1 {
  font-family: var(--font-mono);
  font-size: clamp(2rem, 8dvw, 6rem);
  font-weight: 700;
  line-height: 1.1;
  margin-block-end: 2rem;
  letter-spacing: -0.02em;
}

.dialogue,
[class*="dialogue-delay-"] {
  font-size: clamp(1rem, 3dvw, 1.5rem);
  line-height: 1.6;
  margin-block-end: 1.5rem;
  opacity: 0;
  animation: fade-in var(--duration-med) ease forwards;
  animation-delay: calc(var(--delay, 0) * 0.8s);
}

.dialogue {
  --delay: 0;
}

.dialogue-delay-1 {
  --delay: 1;
}

.dialogue-delay-2 {
  --delay: 2;
}

.dialogue-delay-3 {
  --delay: 3;
}

.dialogue-delay-4 {
  --delay: 4;
}

.dialogue-delay-5 {
  --delay: 5;
}

.small-text {
  font-size: 0.875em;
  color: var(--text-muted);
  font-style: italic;
}

/* Actions */
.action {
  display: inline-block;
  margin-block-start: 3rem;
  cursor: pointer;
  opacity: 0;
  animation: action-appear var(--duration-med) ease 3s forwards;
  position: relative;

  .action-text {
    font-family: var(--font-mono);
    font-size: clamp(0.875rem, 2dvw, 1rem);
    color: var(--text-muted);
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--text-muted);
    display: inline-block;
    transition: all var(--duration-fast);
    border-radius: 0.25rem;
    background: var(--bg);
  }

  &:hover .action-text {
    color: var(--text);
    border-color: var(--text);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  &:active .action-text {
    transform: translateY(0);
  }
}

/* Action Modifiers */
.action-offscreen-right,
.action-offscreen-bottom,
.action-far-corner {
  opacity: 1;
}

.action-offscreen-right {
  position: fixed;
  inset-inline-start: calc(100dvw + 5rem);
  inset-block-start: 50dvh;
  animation: drift-in 4s ease 3s forwards;
}

.action-offscreen-bottom {
  position: fixed;
  inset-inline-start: 50%;
  inset-block-start: calc(100dvh + 5rem);
  translate: -50% 0;
  animation: rise-up 4s ease 3s forwards;
}

.action-far-corner {
  position: fixed;
  inset-inline-end: 2rem;
  inset-block-end: 2rem;
  inset-inline-start: auto;
  margin: 0;

  .action-text {
    font-size: 0.5rem;
    padding: 0.5rem;
  }

  &:hover .action-text {
    font-size: 1rem;
    padding: 0.75rem 1.5rem;
  }
}

.action-tiny {
  .action-text {
    font-size: 0.5rem;
    padding: 0.25rem 0.5rem;
  }

  &:hover .action-text {
    font-size: 1rem;
    padding: 0.75rem 1.5rem;
  }
}

.action-rotated {
  transform: rotateZ(-90deg);
  transform-origin: center;
  transition: transform var(--duration-fast);

  &:hover {
    transform: rotateZ(0deg);
  }
}

.action-heavy {
  cursor: grab;

  &:active {
    cursor: grabbing;
  }

  &:active .action-text {
    transition: transform 3s cubic-bezier(0.4, 0.0, 0.2, 1);
    transform: translateX(100px);
  }
}

.action-upside-down {
  transform: rotateZ(180deg);
  transition: transform var(--duration-fast);

  &:hover {
    transform: rotateZ(180deg) scale(1.1);
  }
}

.action-way-down {
  margin-block-start: 150dvh;
  margin-block-end: 3rem;
}

/* Keyframes */
@keyframes action-appear {
  from {
    opacity: 0;
  }

  to {
    opacity: 1;
  }
}

@keyframes drift-in {
  to {
    inset-inline-start: calc(100dvw - 10rem);
  }
}

@keyframes rise-up {
  to {
    inset-block-start: calc(100dvh - 8rem);
  }
}

@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(0.5rem);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scene-enter {
  from {
    opacity: 0;
    transform: translateY(2rem);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes tumble {
  0% {
    transform: rotateZ(0deg) scale(1);
  }

  100% {
    transform: rotateZ(-360deg) scale(0.8);
  }
}

/* Stage-specific styles nested under :has selectors */

/* Step 0: Cover */
:has(#step-0:checked) {
  .scene-0 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 85%;
    inset-block-start: 50%;
    opacity: 0.6;

    .face {
      transform: rotateY(-20deg);
    }
  }
}

/* Step 1: Angry */
:has(#step-1:checked) {
  .scene-1 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 70%;
    inset-block-start: 30%;

    .face {
      transform: rotateY(0deg) scale(1.1);
      color: transparent;

      &::before {
        content: '[==]';
        color: var(--text);
      }
    }
  }
}

/* Step 2: Word jumble */
:has(#step-2:checked) {
  .scene-2 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 50%;
    inset-block-start: 25%;

    .face {
      transform: rotateX(5deg);
    }
  }

  .word-jumble {
    display: flex;
    flex-wrap: wrap;
    gap: 4rem;
    margin-block: 2rem;
    font-family: var(--font-mono);
    font-size: clamp(0.75rem, 2dvw, 1rem);
    color: var(--text-muted);

    span {
      opacity: 0;
      animation: word-float 1s ease forwards;
      transform-origin: center;
      animation-delay: calc(var(--i) * 0.1s + 2s);
    }
  }
}

/* Step 3: HAH */
:has(#step-3:checked) {
  .scene-3 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 50%;
    inset-block-start: 35%;

    .face {
      transform: scale(1.3);
    }
  }
}

/* Step 4: Deciding */
:has(#step-4:checked) {
  .scene-4 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 75%;
    inset-block-start: 60%;

    .face {
      transform: scale(0.9) rotateZ(-5deg);
      opacity: 0.8;
    }
  }
}

/* Step 5: Scroll warning + blowing words */
:has(#step-5:checked) {
  .scene-5 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 50%;
    inset-block-start: 20%;

    .face {
      transform: scale(1);
      color: transparent;

      &::before {
        content: '[—  —]';
        color: var(--text);
      }
    }
  }

  .action-forbidden .action-text {
    animation: pulse-warning 2s ease infinite;
  }

  .blowing-words {
    position: relative;
    block-size: 200dvh;
    inline-size: 100%;
    min-inline-size: 100%;
    font-family: var(--font-mono);
    font-size: clamp(1rem, 3dvw, 2rem);
    margin-block-start: 3rem;

    span {
      position: absolute;
      inset-inline-start: var(--x, 45%);
      inset-block-start: var(--y, 45%);
      opacity: 1;
      animation: blow-away linear forwards;
      animation-timeline: scroll(block nearest);
      animation-range: entry 10% exit 90%;
      will-change: transform, opacity;
    }

    span:nth-child(odd) {
      --random-x: 80;
      --random-y: -60;
      --random-r: 180;
    }

    span:nth-child(even) {
      --random-x: -80;
      --random-y: -40;
      --random-r: -180;
    }
  }

  .oof-text {
    font-size: clamp(1.5rem, 5dvw, 3rem);
    font-weight: 700;
    margin-block: 2rem;
    opacity: 0;
    animation: fade-in var(--duration-med) ease forwards;
    animation-delay: 0.5s;
  }
}

/* Step 6: Dark void */
:has(#step-6:checked) {
  body {
    background: var(--void);
  }

  .scene-6 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;

    .dialogue {
      color: var(--bg);
    }
  }

  main .character {
    inset-inline-start: 20%;
    inset-block-start: 70%;

    .face {
      transform: rotateZ(-45deg) scale(0.8);
      animation: tumble 2s ease-out;
    }
  }
}

/* Step 7: Heavy rock */
:has(#step-7:checked) {
  .scene-7 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 80%;
    inset-block-start: 50%;

    .face {
      transform: scale(0.5) rotateY(180deg);
      opacity: 0.5;
    }
  }

  .heavy-rock {
    position: relative;
    inline-size: clamp(400px, 80dvw, 800px);
    block-size: clamp(300px, 60dvh, 600px);
    margin-block: 2rem;
    background: linear-gradient(135deg, #4a4a4a 0%, #2a2a2a 100%);
    border-radius: 20% 20% 20% 20%;
    display: grid;
    place-items: center;
    transform-style: preserve-3d;
    animation: rock-drop 1s ease-out 1s backwards;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);

    .rock-text {
      font-family: var(--font-mono);
      font-size: clamp(2.5rem, 7dvw, 5rem);
      font-weight: 700;
      color: rgba(255, 255, 255, 0.3);
      text-align: center;
      line-height: 1.2;
      transform: translateZ(20px);
    }
  }
}

/* Step 8: Strong */
:has(#step-8:checked) {
  .scene-8 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 75%;
    inset-block-start: 45%;

    .face {
      color: transparent;

      &::before {
        content: '[ ○  ○ ]';
        color: var(--text);
      }
    }
  }
}

/* Step 9: Give up */
:has(#step-9:checked) {
  .scene-9 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 65%;
    inset-block-start: 35%;
  }
}

/* Step 10: Name blank */
:has(#step-10:checked) {
  .scene-10 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 50%;
    inset-block-start: 30%;

    .face {
      transform: scale(1);
    }
  }

  .story-text {
    font-family: var(--font-mono);
    font-size: clamp(0.875rem, 2.5dvw, 1.25rem);
  }
}

/* Step 11: Pest story */
:has(#step-11:checked) {
  .scene-11 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 20%;
    inset-block-start: 60%;

    .face {
      transform: rotateZ(-10deg);
    }
  }
}

/* Step 12: YOU */
:has(#step-12:checked) {
  .scene-12 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 50%;
    inset-block-start: 40%;

    .face {
      color: transparent;

      &::before {
        content: '[●  ●]';
        color: var(--text);
      }
    }
  }
}

/* Step 13: Almost done */
:has(#step-13:checked) {
  .scene-13 {
    opacity: 1;
    pointer-events: all;
    animation: scene-enter var(--duration-slow) ease;
    content-visibility: visible;
  }

  main .character {
    inset-inline-start: 60%;
    inset-block-start: 50%;

    .face {
      color: transparent;

      &::before {
        content: '[- ⌣ -]';
        color: var(--text);
      }
    }
  }

  .final-text {
    font-style: italic;
    color: var(--text-muted);
    margin-block-start: 2rem;
  }

  .the-end {
    margin-block-start: 4rem;
    opacity: 0;
    animation: fade-in var(--duration-slow) ease 6s forwards;

    p:first-child {
      font-family: var(--font-mono);
      font-size: clamp(1.5rem, 5dvw, 3rem);
      font-weight: 700;
      margin-block-end: 1rem;
    }
  }
}

/* Blow away animation */
@keyframes blow-away {
  0% {
    opacity: 1;
    transform: translateX(0) translateY(0) rotateZ(0deg) scale(1);
  }

  100% {
    opacity: 0;
    transform: translateX(calc(var(--random-x, 100) * 1dvw)) translateY(calc(var(--random-y, -50) * 1dvh)) rotateZ(calc(var(--random-r, 360) * 1deg)) scale(0.3);
  }
}

@keyframes word-float {
  from {
    opacity: 0;
    transform: translateY(-1rem) rotate(calc(var(--i) * 60deg));
  }

  to {
    opacity: 1;
    transform: translateY(0) rotate(calc(var(--i) * 72deg));
  }
}

@keyframes pulse-warning {

  0%,
  100% {
    border-color: var(--text-muted);
    color: var(--text-muted);
  }

  50% {
    border-color: rgba(200, 0, 0, 0.6);
    color: rgba(200, 0, 0, 0.8);
  }
}

@keyframes rock-drop {
  0% {
    transform: translateY(-100dvh) rotateZ(-20deg);
    opacity: 0;
  }

  70% {
    transform: translateY(0) rotateZ(2deg);
  }

  85% {
    transform: translateY(-10px) rotateZ(-1deg);
  }

  100% {
    transform: translateY(0) rotateZ(0deg);
    opacity: 1;
  }
}

/* Media Queries */
@media (max-width: 768px) {
  .scene {
    padding-inline-start: 1rem;
    padding-block-start: 2rem;
  }

  .dialogue {
    font-size: 1rem;
    margin-block-end: 1rem;
  }

  .action {
    margin-block-start: 2rem;
  }

  .action-offscreen-right {
    inset-inline-start: calc(100dvw + 2rem);
  }

  @keyframes drift-in {
    to {
      inset-inline-start: calc(100dvw - 6rem);
    }
  }

  .action-way-down {
    margin-block-start: 200dvh;
  }
}

@media (prefers-reduced-motion: reduce) {

  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-delay: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

@media (prefers-contrast: high) {
  :root {
    --bg: #ffffff;
    --text: #000000;
    --text-muted: #333333;
  }
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #1a1a1a;
    --text: #e0e0e0;
    --text-muted: #888888;
    --void: #000000;
  }
}

::selection {
  background: var(--accent);
  color: var(--bg);
}